<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Ventoy Support - Neonatox Live Boot</title>
</head>
<body>

<h1>Ventoy Support Design</h1>

<p>
This document explains how Neonatox Live Boot achieves full compatibility with
Ventoy <strong>without modifying, patching, or depending on Ventoy internals</strong>.
The solution is implemented entirely inside the custom <code>initramfs</code>
and <code>build.sh</code>.
</p>

<h2>Why Ventoy Is Special</h2>

<p>
Ventoy does not boot a Linux ISO in the traditional way.
Instead of extracting files, Ventoy:
</p>

<ul>
  <li>Boots the kernel and initramfs from the ISO</li>
  <li>Leaves the ISO file intact on a data partition</li>
  <li>Allows multiple ISO files to coexist on the same USB</li>
  <li>Injects helper directories such as <code>/ventoy</code> or <code>/vtoy</code></li>
</ul>

<p>
Because of this, assumptions commonly made by live systems often fail:
</p>

<ul>
  <li>The boot filesystem is not necessarily ISO9660</li>
  <li>The root filesystem is not mounted automatically</li>
  <li>The correct ISO cannot be reliably identified by name or label</li>
</ul>

<h2>Design Goals</h2>

<ul>
  <li>No Ventoy patches or hooks</li>
  <li>No reliance on ISO filenames</li>
  <li>No reliance on filesystem labels</li>
  <li>Works with multiple ISOs on the same USB</li>
  <li>Safe and deterministic ISO selection</li>
</ul>

<h2>Filesystem Support</h2>

<p>
Ventoy USB partitions commonly use filesystems such as:
</p>

<ul>
  <li>FAT / VFAT</li>
  <li>exFAT</li>
  <li>NTFS</li>
</ul>

<p>
To ensure access to Ventoy partitions, the initramfs explicitly loads:
</p>

<pre>
iso9660
vfat
fat
exfat
ntfs3
</pre>

<p>
This guarantees that the partition containing ISO files can be mounted
regardless of the filesystem chosen by the user.
</p>

<h2>ISO Matching by Cryptographic Hash</h2>

<p>
The key design decision that makes Ventoy support reliable is
<strong>cryptographic matching of the root filesystem</strong>.
</p>

<h3>build.sh Responsibility</h3>

<p>
During build time, <code>build.sh</code> computes the SHA256 checksum of
<code>rootfs.squashfs</code> and embeds it into the initramfs as:
</p>

<pre>
/rootfs.sha256
</pre>

<p>
This permanently binds the initramfs to the exact root filesystem it expects.
</p>

<h3>init Responsibility</h3>

<p>
At boot time, the initramfs:
</p>

<ul>
  <li>Mounts candidate partitions</li>
  <li>Scans for ISO files in the root of the filesystem</li>
  <li>Loop-mounts each ISO</li>
  <li>Checks for <code>rootfs.squashfs</code> inside the ISO</li>
  <li>Computes its SHA256 hash</li>
  <li>Compares it with <code>/rootfs.sha256</code></li>
</ul>

<p>
Only when the hashes match is the ISO accepted as the correct boot source.
</p>

<h2>Ventoy Environment Detection</h2>

<p>
The initramfs detects a Ventoy environment using a minimal and stable condition:
</p>

<pre>
/ventoy  or  /vtoy
</pre>

<p>
These directories are injected by Ventoy and are present both in legacy and UEFI
Ventoy boot modes.
</p>

<h2>Critical Detail: BusyBox losetup Limitation</h2>

<p>
The final issue preventing Ventoy boot was <strong>not Ventoy itself</strong>,
but a limitation of the BusyBox implementation used inside the initramfs.
</p>

<h3>The Problem</h3>

<p>
Many full Linux systems rely on:
</p>

<pre>
losetup --show -f file.iso
</pre>

<p>
However, the BusyBox <code>losetup</code> applet does <strong>not</strong>
support the <code>--show</code> option.
</p>

<p>
As a result:
</p>

<ul>
  <li>The command silently failed</li>
  <li>The loop device variable remained empty</li>
  <li>The ISO was never actually mounted</li>
  <li><code>rootfs.squashfs</code> was never found</li>
</ul>

<p>
This created a false impression that Ventoy was incompatible.
</p>

<h3>The Solution</h3>

<p>
The fix was to explicitly query the loop device after attachment:
</p>

<pre>
LOOP="$(losetup -f "$ISO" &amp;&amp; losetup -a | grep "$ISO" | sed 's/:.*//')"
</pre>

<p>
This approach:
</p>

<ul>
  <li>Works with BusyBox</li>
  <li>Does not require GNU util-linux</li>
  <li>Correctly retrieves the loop device</li>
  <li>Restores reliable ISO mounting</li>
</ul>

<p>
Once this change was applied, Ventoy boot worked correctly and consistently.
</p>

<h2>Why This Matters</h2>

<p>
This highlights an important lesson when designing initramfs-based systems:
</p>

<ul>
  <li>Tool behavior inside initramfs is not the same as a full system</li>
  <li>BusyBox applets have reduced feature sets</li>
  <li>Silent failures can lead to misleading conclusions</li>
</ul>

<p>
Ventoy itself was functioning exactly as designed.
</p>

<h2>Summary</h2>

<ul>
  <li>Ventoy support is fully initramfs-driven</li>
  <li>No Ventoy patches or plugins are required</li>
  <li>ISO selection is cryptographically verified</li>
  <li>The final blocker was a BusyBox limitation, not Ventoy</li>
  <li>The solution is portable, robust, and maintainable</li>
</ul>

<p>
This design preserves Neonatoxâ€™s educational philosophy while achieving
real-world compatibility with modern multiboot tools.
</p>

</body>
</html>
