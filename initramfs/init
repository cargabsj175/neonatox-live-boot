#!/bin/sh
PATH=/sbin:/bin:/usr/bin:/usr/sbin

echo "================================================================"
echo "===== Neonatox Live Boot - v0.3 Carlos Sanchez - 2007-2026 ====="
echo "================================================================"

# --------------------------------------------------
# Config
# --------------------------------------------------
[ "$debug" = "1" ] && set -x
ISO_MNT="/mnt/iso"
FOUND_DEV=""

# --------------------------------------------------
# 1. Console and virtual filesystem
# --------------------------------------------------
mount -t proc proc /proc
mount -t sysfs sysfs /sys
sleep 1
mdev -s
mount -t tmpfs tmpfs /run

echo "[OK] basic mounts ready"

# --------------------------------------------------
# 2. Create loop nodes
# --------------------------------------------------
for i in 0 1 2 3 4 5 6 7; do
    [ -b /dev/loop$i ] || mknod /dev/loop$i b 7 $i
done

# --------------------------------------------------
# 3. Load necessary modules
# --------------------------------------------------
ESSENTIAL_MODULES="cdrom sd_mod sr_mod loop squashfs overlay usb-storage uas ahci libata"
LEGACY_MODULES="ata_piix pata_generic"  # old IDE
NVME_MODULES="nvme nvme_core"           # modern NVMe
HID_MODULES="hid-generic usbhid i8042 atkbd libps2"  # Keyboard

for m in $ESSENTIAL_MODULES $LEGACY_MODULES $NVME_MODULES $HID_MODULES; do
    modprobe $m 2>/dev/null
done

sleep 1
mdev -s

# --------------------------------------------------
# 4. Smart Scan (3 fast attempts)
# --------------------------------------------------
echo "[INFO] scanning for boot media..."

for attempt in 1 2 3; do
    echo "  attempt $attempt/3"
    
    # NVMe doesn't need scanning, just wait a little while
    [ $attempt -eq 1 ] && sleep 0.5
    
    # SCSI scan (SATA, USB)
    for host in /sys/class/scsi_host/host*; do
        echo "- - -" > "$host/scan" 2>/dev/null || true
    done
    
    sleep 1
    mdev -s
    
    # Search in ORDER: CD/DVD first, then partitions
    for DEV in \
        /dev/sr*  \
        /dev/nvme*n*p* /dev/nvme*n \
        /dev/sd* \
        /dev/hd* \
        /dev/mmcblk*p* /dev/mmcblk*
    do
        [ -e "$DEV" ] || continue
        
        case "$DEV" in
            /dev/hd*) sleep 1 ;;  # IDE (slow)
        esac
        
        echo "    checking $DEV"
        if mount -o ro "$DEV" "$ISO_MNT" 2>/dev/null; then
            if [ -f "$ISO_MNT/rootfs.squashfs" ]; then
                FOUND_DEV="$DEV"
                break 2  # Break both loops
            fi
            umount "$ISO_MNT" 2>/dev/null || umount -l "$ISO_MNT"
        fi
    done
done

# --------------------------------------------------
# 5. Error if not found
# --------------------------------------------------
if [ -z "$FOUND_DEV" ]; then
    echo "[ERROR] rootfs.squashfs not found"
    echo "Available devices:"
    ls -l /dev/sd* /dev/hd* /dev/nvme* /dev/mmcblk* /dev/sr* 2>/dev/null || true
    exec sh  # Emergency Shell
fi

echo "[OK] found boot media at $FOUND_DEV"

# ---------------------------------------------
# 6. Mount squashfs
# ---------------------------------------------
mkdir -p /mnt/ro_root

mount -t squashfs -o loop "$ISO_MNT/rootfs.squashfs" /mnt/ro_root || {
    echo "[ERROR] cannot mount squashfs"
    exec sh
}

echo "[OK] squashfs mounted"

# ---------------------------------------------
# 7. OverlayFS
# ---------------------------------------------
mkdir -p /mnt/ram
mkdir -p /mnt/newroot

mount -t tmpfs tmpfs /mnt/ram || {
    echo "[ERROR] tmpfs mount failed"
    exec sh
}

mkdir -p /mnt/ram/upper
mkdir -p /mnt/ram/work

mount -t overlay overlay \
    -o lowerdir=/mnt/ro_root,upperdir=/mnt/ram/upper,workdir=/mnt/ram/work \
    /mnt/newroot || {
        echo "[ERROR] overlay mount failed"
        exec sh
    }

echo "[OK] overlay mounted"

# ---------------------------------------------
# 8. Fresh virtual filesystems for newroot
# ---------------------------------------------
mkdir -p /mnt/newroot/proc
mkdir -p /mnt/newroot/sys
mkdir -p /mnt/newroot/dev
mkdir -p /mnt/newroot/run

mount -t proc  proc  /mnt/newroot/proc
mount -t sysfs sysfs /mnt/newroot/sys
mount -t devtmpfs devtmpfs /mnt/newroot/dev
mkdir -p /mnt/newroot/dev/pts
mount -t devpts devpts -o gid=5,mode=0620 /mnt/newroot/dev/pts
mount -t tmpfs tmpfs /mnt/newroot/run

[ -c /mnt/newroot/dev/console ] || mknod -m 600 /mnt/newroot/dev/console c 5 1
[ -c /mnt/newroot/dev/null ] || mknod -m 666 /mnt/newroot/dev/null c 1 3

# ---------------------------------------------
# 9. machine-id (systemd) & minimal fstab
# ---------------------------------------------

mkdir -p /mnt/newroot/etc
[ -f /mnt/newroot/etc/machine-id ] || \
    touch /mnt/newroot/etc/machine-id

cat > /mnt/newroot/etc/fstab <<EOF
proc  /proc  proc  defaults  0 0
sysfs /sys   sysfs defaults  0 0
devpts /dev/pts devpts defaults  0 0
tmpfs /run   tmpfs defaults  0 0
EOF

# ---------------------------------------------
# 10. Switch root (universal)
# ---------------------------------------------
if [ -x /mnt/newroot/lib/systemd/systemd ]; then
    echo "[BOOT] starting systemd"
    exec switch_root /mnt/newroot /lib/systemd/systemd
elif [ -x /mnt/newroot/sbin/init ]; then
    echo "[BOOT] starting /sbin/init"
    exec switch_root /mnt/newroot /sbin/init
else
    echo "[FATAL] No init found in new root"
    exec sh
fi
