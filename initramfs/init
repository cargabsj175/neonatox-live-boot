#!/bin/sh
PATH=/sbin:/bin:/usr/bin:/usr/sbin

echo "================================================================"
echo "===== Neonatox Live Boot - v0.1 Carlos Sanchez - 2007-2026 ====="
echo "================================================================"
sleep 2

# --------------------------------------------------
# Console and virtual filesystem
# --------------------------------------------------
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t tmpfs tmpfs /run
sleep 1
mdev -s

echo "[OK] basic mounts ready"

# --------------------------------------------------
# Create loop nodes
# --------------------------------------------------
for i in 0 1 2 3 4 5 6 7; do
    [ -b /dev/loop$i ] || mknod /dev/loop$i b 7 $i
done

# --------------------------------------------------
# Load necessary modules
# --------------------------------------------------
for m in \
    cdrom sd_mod sr_mod \
    loop squashfs overlay \
    usb-storage uas \
    ahci libata \
    hid hid-generic usbhid \
    i8042 atkbd libps2
do
    modprobe $m 2>/dev/null
done

# --------------------------------------------------
# Force device detection
# --------------------------------------------------
echo "[INFO] rescanning SCSI hosts..."
for host in /sys/class/scsi_host/host*; do
    echo "- - -" > "$host/scan"
done

sleep 1
mdev -s

# --------------------------------------------------
# Search rootfs.squashfs
# --------------------------------------------------
ISO_MNT="/mnt/iso"
mkdir -p "$ISO_MNT"
FOUND_DEV=""

echo "[INFO] searching for rootfs.squashfs..."

for DEV in \
    /dev/sr0 \
    /dev/sd?? \
    /dev/sd? \
    /dev/nvme?n?p? \
    /dev/mmcblk?p?
do
    [ -e "$DEV" ] || continue

    echo "  trying $DEV"
    mount -o ro "$DEV" "$ISO_MNT" 2>/dev/null || continue

    if [ -f "$ISO_MNT/rootfs.squashfs" ]; then
        FOUND_DEV="$DEV"
        break
    fi

    umount "$ISO_MNT"
done

if [ -z "$FOUND_DEV" ]; then
    echo "[ERROR] rootfs.squashfs not found"
    exec sh
fi

echo "[OK] found rootfs on $FOUND_DEV"

# ---------------------------------------------
# Mount squashfs
# ---------------------------------------------
mkdir -p /mnt/ro_root

mount -t squashfs -o loop "$ISO_MNT/rootfs.squashfs" /mnt/ro_root || {
    echo "[ERROR] cannot mount squashfs"
    exec sh
}

echo "[OK] squashfs mounted"

# ---------------------------------------------
# OverlayFS
# ---------------------------------------------
mkdir -p /mnt/ram
mkdir -p /mnt/newroot

mount -t tmpfs tmpfs /mnt/ram || {
    echo "[ERROR] tmpfs mount failed"
    exec sh
}

mkdir -p /mnt/ram/upper
mkdir -p /mnt/ram/work

mount -t overlay overlay \
    -o lowerdir=/mnt/ro_root,upperdir=/mnt/ram/upper,workdir=/mnt/ram/work \
    /mnt/newroot || {
        echo "[ERROR] overlay mount failed"
        exec sh
    }

echo "[OK] overlay mounted"

# ---------------------------------------------
# Fresh virtual filesystems for newroot
# ---------------------------------------------
mkdir -p /mnt/newroot/proc
mkdir -p /mnt/newroot/sys
mkdir -p /mnt/newroot/dev
mkdir -p /mnt/newroot/run
# Prevents failures in dbus (systemd)
mkdir -p /mnt/newroot/run/dbus

mount -t proc  proc  /mnt/newroot/proc
mount -t sysfs sysfs /mnt/newroot/sys
mount -t devtmpfs devtmpfs /mnt/newroot/dev
mkdir -p /mnt/newroot/dev/pts
mount -t devpts devpts -o gid=5,mode=0620 /mnt/newroot/dev/pts
mount -t tmpfs tmpfs /mnt/newroot/run

[ -c /mnt/newroot/dev/console ] || mknod -m 600 /mnt/newroot/dev/console c 5 1
[ -c /mnt/newroot/dev/null ] || mknod -m 666 /mnt/newroot/dev/null c 1 3

# ---------------------------------------------
# machine-id (systemd)
# ---------------------------------------------

mkdir -p /mnt/newroot/etc
[ -f /mnt/newroot/etc/machine-id ] || \
    touch /mnt/newroot/etc/machine-id

# ---------------------------------------------
# Minimal fstab
# ---------------------------------------------

cat > /mnt/newroot/etc/fstab <<EOF
proc  /proc  proc  defaults  0 0
sysfs /sys   sysfs defaults  0 0
devpts /dev/pts devpts defaults  0 0
tmpfs /run   tmpfs defaults  0 0
EOF

# ---------------------------------------------
# Switch root (universal)
# ---------------------------------------------
if [ -x /mnt/newroot/lib/systemd/systemd ]; then
    echo "[BOOT] starting systemd"
    exec switch_root /mnt/newroot /lib/systemd/systemd
elif [ -x /mnt/newroot/sbin/init ]; then
    echo "[BOOT] starting /sbin/init"
    exec switch_root /mnt/newroot /sbin/init
else
    echo "[FATAL] No init found in new root"
    exec sh
fi
